<div class="incident-search-container">


  <div class="search-form">
    <div class="form-grid">
      <div class="form-field">
        <label for="title">{{ 'INCIDENT.FILTERS.TITLE' | translate }}</label>
        <input
          type="text"
          id="title"
          [value]="filters().title"
          (input)="updateFilter('title', $any($event.target).value)"
          [placeholder]="'INCIDENT.FILTERS.TITLE_PLACEHOLDER' | translate"
          (keyup.enter)="searchIncidents()"/>
      </div>

      <div class="form-field">
        <label for="description">{{ 'INCIDENT.FILTERS.DESCRIPTION' | translate }}</label>
        <input
          type="text"
          id="description"
          [value]="filters().description"
          (input)="updateFilter('description', $any($event.target).value)"
          [placeholder]="'INCIDENT.FILTERS.DESCRIPTION_PLACEHOLDER' | translate"
          (keyup.enter)="searchIncidents()"/>
      </div>

      <div class="form-field">
        <label for="severity">{{ 'INCIDENT.FILTERS.SEVERITY' | translate }}</label>
        <select
          id="severity"
          [value]="filters().severity"
          (change)="updateFilter('severity', $any($event.target).value)">
          <option value="">{{ 'INCIDENT.FILTERS.SEVERITY_ALL' | translate }}</option>
          <option value="LOW">LOW</option>
          <option value="MEDIUM">MEDIUM</option>
          <option value="HIGH">HIGH</option>
        </select>
      </div>

      <div class="form-field">
        <label for="owner">{{ 'INCIDENT.FILTERS.OWNER' | translate }}</label>
        <input
          type="text"
          id="owner"
          [value]="filters().owner"
          (input)="updateFilter('owner', $any($event.target).value)"
          [placeholder]="'INCIDENT.FILTERS.OWNER_PLACEHOLDER' | translate"
          (keyup.enter)="searchIncidents()"/>
      </div>
    </div>

    <div class="button-group">
      <button
        class="btn btn-primary"
        (click)="searchIncidents()"
        [disabled]="isLoading()">
        {{ (isLoading() ? 'INCIDENT.SEARCHING' : 'INCIDENT.SEARCH') | translate }}
      </button>
      <button
        class="btn btn-secondary"
        (click)="resetFilters()"
        [disabled]="isLoading()">
        {{ 'INCIDENT.RESET' | translate }}
      </button>
    </div>
  </div>

  @if (lastQueryTime() !== null) {
    <div class="query-info">
      <span class="query-time">
        {{ 'INCIDENT.EXECUTION_TIME' | translate: {time: lastQueryTime()!.toFixed(3)} }}
      </span>
      @if (!errorMessage()) {
        <span class="result-count">
          {{ 'INCIDENT.RESULT_COUNT' | translate: {count: totalElements()} }}
        </span>
      }
    </div>
  }

  @if (errorMessage()) {
    <div class="error-message">
      {{ 'INCIDENT.ERROR' | translate: {message: errorMessage()} }}
    </div>
  }

  @if (incidents().length > 0) {
    <div class="results-container">
      <div class="table-wrapper">
        <table class="incidents-table">
          <thead>
          <tr>
            <th class="sortable" (click)="changeSort('id')">
              {{ 'INCIDENT.TABLE.ID' | translate }}
              @if (isSorted('id')) {
                <span class="sort-indicator">{{ getSortDirection('id') === 'asc' ? '▲' : '▼' }}</span>
              }
            </th>
            <th class="sortable" (click)="changeSort('title')">
              {{ 'INCIDENT.TABLE.TITLE' | translate }}
              @if (isSorted('title')) {
                <span class="sort-indicator">{{ getSortDirection('title') === 'asc' ? '▲' : '▼' }}</span>
              }
            </th>
            <th class="sortable" (click)="changeSort('description')">
              {{ 'INCIDENT.TABLE.DESCRIPTION' | translate }}
              @if (isSorted('description')) {
                <span class="sort-indicator">{{ getSortDirection('description') === 'asc' ? '▲' : '▼' }}</span>
              }
            </th>
            <th class="sortable" (click)="changeSort('severity')">
              {{ 'INCIDENT.TABLE.SEVERITY' | translate }}
              @if (isSorted('severity')) {
                <span class="sort-indicator">{{ getSortDirection('severity') === 'asc' ? '▲' : '▼' }}</span>
              }
            </th>
            <th class="sortable" (click)="changeSort('createdAt')">
              {{ 'INCIDENT.TABLE.CREATED_AT' | translate }}
              @if (isSorted('createdAt')) {
                <span class="sort-indicator">{{ getSortDirection('createdAt') === 'asc' ? '▲' : '▼' }}</span>
              }
            </th>
            <th class="sortable" (click)="changeSort('ownerLastName')">
              {{ 'INCIDENT.TABLE.OWNER_LASTNAME' | translate }}
              @if (isSorted('ownerLastName')) {
                <span class="sort-indicator">{{ getSortDirection('ownerLastName') === 'asc' ? '▲' : '▼' }}</span>
              }
            </th>
            <th class="sortable" (click)="changeSort('ownerFirstName')">
              {{ 'INCIDENT.TABLE.OWNER_FIRSTNAME' | translate }}
              @if (isSorted('ownerFirstName')) {
                <span class="sort-indicator">{{ getSortDirection('ownerFirstName') === 'asc' ? '▲' : '▼' }}</span>
              }
            </th>
            <th class="sortable" (click)="changeSort('ownerEmail')">
              {{ 'INCIDENT.TABLE.OWNER_EMAIL' | translate }}
              @if (isSorted('ownerEmail')) {
                <span class="sort-indicator">{{ getSortDirection('ownerEmail') === 'asc' ? '▲' : '▼' }}</span>
              }
            </th>
          </tr>
          </thead>
          <tbody>
            @for (incident of incidents(); track incident.id) {
              <tr [class.severity-high]="incident.severity === 'HIGH'"
                  [class.severity-medium]="incident.severity === 'MEDIUM'"
                  [class.severity-low]="incident.severity === 'LOW'">
                <td>{{ incident.id }}</td>
                <td class="title-cell">{{ incident.title }}</td>
                <td class="description-cell">{{ incident.description }}</td>
                <td>
                  <span class="severity-badge" [class]="'severity-' + incident.severity.toLowerCase()">
                    {{ incident.severity }}
                  </span>
                </td>
                <td>{{ formatDate(incident.createdAt) }}</td>
                <td>{{ incident.ownerLastName }}</td>
                <td>{{ incident.ownerFirstName }}</td>
                <td>{{ incident.ownerEmail }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="pagination-controls">
        <div class="pagination-info">
          {{ 'INCIDENT.PAGINATION.PAGE_INFO' | translate: {current: currentPage() + 1, total: totalPages()} }}
        </div>
        <div class="pagination-buttons">
          <button
            class="btn btn-pagination"
            (click)="previousPage()"
            [disabled]="!hasPrevious() || isLoading()">
            ← {{ 'INCIDENT.PAGINATION.PREVIOUS' | translate }}
          </button>
          <select
            class="page-size-selector"
            [value]="pageSize()"
            (change)="changePageSize(+$any($event.target).value)"
            [disabled]="isLoading()">
            <option [value]="5">5 par page</option>
            <option [defaultSelected]="10" [value]="10">10 par page</option>
            <option [value]="25">25 par page</option>
            <option [value]="50">50 par page</option>
            <option [value]="100">100 par page</option>
          </select>
          <button
            class="btn btn-pagination"
            (click)="nextPage()"
            [disabled]="!hasNext() || isLoading()">
            {{ 'INCIDENT.PAGINATION.NEXT' | translate }} →
          </button>
        </div>
      </div>
    </div>
  }

  @if (!isLoading() && incidents().length === 0 && lastQueryTime() !== null && !errorMessage()) {
    <div class="no-results">
      {{ 'INCIDENT.NO_RESULTS' | translate }}
    </div>
  }
</div>
